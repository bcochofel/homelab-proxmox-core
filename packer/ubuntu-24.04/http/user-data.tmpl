#cloud-config
autoinstall:
  version: 1

  # Locale / keyboard / hostname
  locale: ${locale}
  keyboard:
    layout: ${keyboard_layout}
    variant: ${keyboard_variant}
  identity:
    hostname: ${hostname}
    username: ${ubuntu_username}
    # Provide a SHA-512 password hash via the variable `ubuntu_password_hash`
    # Example: $6$randomsalt$...
    password: "${ubuntu_password_hash}"

  # SSH server: key-only, no password auth
  ssh:
    install-server: true
    allow-pw: false
    ssh_quiet_keygen: true
    disable_root: true
    authorized-keys:
%{ for u in users ~}
%{ if length(u.ssh_authorized_keys) > 0 ~}
%{ for k in u.ssh_authorized_keys ~}
      - ${k}
%{ endfor ~}
%{ endif ~}
%{ endfor ~}

  # Storage: insert YAML fragment provided by the variable 'storage_config'
  storage:
${indent(2, storage_config)}

  # Packages to install during autoinstall
  packages:
%{ for pkg in packages ~}
    - ${pkg}
%{ endfor ~}

  # Timezone (top-level autoinstall field)
  timezone: ${timezone}

  # cloud-init user-data section (additional cloud-config for the installed system)
  user-data:
    disable_root: true
    timezone: ${timezone}
    # Create additional users from the 'users' variable
    users:
%{ for u in users ~}
      - name: ${u.name}
        lock-passwd: ${u.lock_passwd}
        shell: ${u.shell}
        groups:
%{ for g in u.groups ~}
          - ${g}
%{ endfor ~}
%{ if u.sudo == true }
        sudo: ALL=(ALL) NOPASSWD:ALL
%{ endif ~}
%{ if length(u.ssh_authorized_keys) > 0 }
        ssh_authorized_keys:
%{ for k in u.ssh_authorized_keys ~}
          - ${k}
%{ endfor ~}
%{ endif ~}
%{ endfor ~}
